build-64:
  stage: package
  image:
    name: ghcr.io/friendsofshopware/platform-plugin-dev:v6.4.5
    entrypoint: [""]
  before_script:
    - echo ""
  only:
    - tags
    - master
    - /^integration.*$/
    - /^fix.*$/
  except:
    variables: [ $DISABLE_PACKAGE == "1" ]
  script:
    - start-mysql
    - ln -s "$(pwd)" "/plugins/${CI_PROJECT_NAME}"
    - jq '.version = .version + "64"' /plugins/${CI_PROJECT_NAME}/composer.json > /plugins/${CI_PROJECT_NAME}/composer.tmp && mv /plugins/${CI_PROJECT_NAME}/composer.tmp /plugins/${CI_PROJECT_NAME}/composer.json
    - jq '.require."shopware/administration" = "~6.4.0"' /plugins/${CI_PROJECT_NAME}/composer.json > /plugins/${CI_PROJECT_NAME}/composer.tmp && mv /plugins/${CI_PROJECT_NAME}/composer.tmp /plugins/${CI_PROJECT_NAME}/composer.json
    - jq '.require."shopware/core" = "~6.4.0"' /plugins/${CI_PROJECT_NAME}/composer.json > /plugins/${CI_PROJECT_NAME}/composer.tmp && mv /plugins/${CI_PROJECT_NAME}/composer.tmp /plugins/${CI_PROJECT_NAME}/composer.json
    - jq '.require."shopware/storefront" = "~6.4.0"' /plugins/${CI_PROJECT_NAME}/composer.json > /plugins/${CI_PROJECT_NAME}/composer.tmp && mv /plugins/${CI_PROJECT_NAME}/composer.tmp /plugins/${CI_PROJECT_NAME}/composer.json
    - sed '1 s_$_64_' /plugins/${CI_PROJECT_NAME}/CHANGELOG_en-GB.md > /plugins/${CI_PROJECT_NAME}/CHANGELOG_en-GB.tmp && mv /plugins/${CI_PROJECT_NAME}/CHANGELOG_en-GB.tmp /plugins/${CI_PROJECT_NAME}/CHANGELOG_en-GB.md
    - sed '1 s_$_64_' /plugins/${CI_PROJECT_NAME}/CHANGELOG_de-DE.md > /plugins/${CI_PROJECT_NAME}/CHANGELOG_de-DE.tmp && mv /plugins/${CI_PROJECT_NAME}/CHANGELOG_de-DE.tmp /plugins/${CI_PROJECT_NAME}/CHANGELOG_de-DE.md
    - plugin-uploader ext:prepare "/plugins/${CI_PROJECT_NAME}"
    - rm -rf $( cat .sw-zip-blocklist ) && rm -rf .sw-zip-blocklist
    - pack-plugin ${CI_PROJECT_NAME}
    - plugin-uploader ext:validate "$(realpath "$(find . -type f -name "*.zip" -print0 -maxdepth 1)")"
  artifacts:
    paths:
      - "*.zip"
    expire_in: 1 week
